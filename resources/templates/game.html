{% extends "layout.html" %}

{% block title %}
{{game.home_team}} vs {{game.away_team}}

{% endblock %}

{% block content %}
<h1>{{game.home_team}} <br/>vs<br/> {{game.away_team}}</h1>
<hr/>

<div class="medium-centered medium-8 columns text-left">
  <form method="POST" action="/{{base}}/games/{{game.id}}">
    <input type="hidden" name="teamId" value="{{teamId}}"/>
    <div class="row">
      <div class="medium-6 columns">
        <label>Starts
          <input type="text" value="{{game.starts_at}}" {{permissions.details}}/>
        </label>
      </div>
      <div class="medium-6 columns">
        <label>Field
          <input type="text" value="{{game.field}}" {{permissions.details}}/>
        </label>
      </div>
    </div>
    <div class="row">
      <div class="small-10 columns">
        <label>Home Team
          <input type="text" value="{{game.home_team}}" {{permissions.details}}/>
        </label>
      </div>
      <div class="small-2 columns">
        <label>Score
          <input type="text" name="home_score" value="{{game.ht_score}}" {{permissions.score}}/>
        </label>
      </div>
    </div>
    <div class="row">
      <div class="small-10 columns">
        <label>Away Team
          <input type="text" value="{{game.away_team}}" {{permissions.details}}/>
        </label>
      </div>
      <div class="small-2 columns">
        <label>Score
          <input type="text" name="away_score" value="{{game.at_score}}" {{permissions.score}}/>
        </label>
      </div>
    </div>
    {% if permissions.update %}
      <div class="row">
        <div class="small-3 small-centered columns">
          <input type="submit" class="button" name="Save"/>
        </div>
      </form>
    {% endif %}
    <div id="app"></div>
    <div id="stats"></div>
  </div>
</div>

<script type="text/javascript">
var editable = {{permissions.update|default:false}};
var players = {{players|json|safe}};
</script>

<script id="stat-display-template" type="text/x-backbone">
<div class="row">
    <div class="small-12 medium-2 columns">
      <span><%= name %></span>
    </div>
    <div class="small-2 medium-2 columns">
      <span><%= goals %> Goals</span>
    </div>
    <div class="small-2 medium-2 columns">
      <span><%= assists %> Assists</span>
    </div>
    <div class="small-3 medium-2 columns">
      <%= getCardLabel() %> Card
    </div>
    <% if (editable) { %>
      <div class="small-5 medium-4 columns">
          <a id="edit">Edit</a>
          <a id="remove" class="">Remove</a>
      </div>
    <% } %>
  </div>
</script>

<script id="stat-template" type="text/x-backbone">
<div class="row">
  <form id="player_stats">
    <div class="small-12 medium-7 columns">
      <label>Player
        <select class="name">
        <% _.each(players, function(player){ %>
          <option value="<%=player.id%>"><%=player.team + '-' + player.name%></option>
        <% }); %>
        </select>
      </label>
    </div>
    <div class="small-2 medium-1 columns">
      <label>Goals
        <input type="text" class="goals" value="<%= goals %>"/>
      </label>
    </div>
    <div class="small-2 medium-1 columns">
      <label>Assists
        <input type="text" class="assists" value="<%= assists %>"/>
      </label>
    </div>
    <div class="small-3 medium-3 columns">
      <label>Card
        <select class="card">
          <option value="N" <%= isCardChecked('N') %>>None</option>
          <option value="Y" <%= isCardChecked('Y') %>>Yellow</option>
          <option value="R" <%= isCardChecked('R') %>>Red</option>
        </select>
      </label>
    </div>
  </div>
  <div class="row">
    <div class="small-12 medium-4 columns small-centered">
      <ul class="button-group">
        <li><a id="cancel" class="tiny button">Cancel</a></li>
        <li><a id="saved" class="tiny button">Save</a></li>
      </ul>
    </div>
  </div>
  </form>
</div>
</script>

<script src="/js/sawesomeness.js"></script>
<script>

var app = new Marionette.Application();

var AppRouter = Backbone.Router.extend({
  routes: {
    "" : "showUserList"
  },

  showUserList : function() {
    app.AppController.showUserList();
    if(editable) {
      app.otherRegion.show(new FooView());
    }
  }
});

var AppController = Marionette.Controller.extend({
  showUserList: function() {
      var userListView = new UserListView({ collection: app.collection});
      app.mainRegion.show(userListView);
    }
});

app.addInitializer(function() {
  app.addRegions({
    mainRegion : '#app',
    otherRegion : '#stats'
  });

  app.AppController = new AppController();
  app.Router = new AppRouter();
  app.collection = new UserModels();

  app.collection.fetch();

  Backbone.history.start();
});

var FooView = Marionette.ItemView.extend({
  template: _.template("<a id='addStat'>Add Player Details</a>"),

  events: {
    "click #addStat" : "showEntryScreen"
  },

  showEntryScreen: function(ev) {
    app.otherRegion.show(new AddEntryView({model: new UserModel() }));
  }

});

var AddEntryView = Marionette.ItemView.extend({
  template: "#stat-template",

  events: {
    "click #cancel" : "cancel",
    "click #saved" : "save"
  },

  save: function(ev) {
    app.collection.create({
      "id" : $('.name', this.$el).val(),
      "playername": $(".name option:selected", this.$el).text(),
      "goals": $('.goals', this.$el).val(),
      "assists": $('.assists', this.$el).val(),
      "card": $('.card', this.$el).val()
    });

    app.otherRegion.show(new FooView());
  },

  templateHelpers: function () {
    return {
      isCardChecked: function(value){
        return this.card === value ? 'selected' : "";
      }
    };
  },

  serializeData: function() {
    return {
      name: this.model.get('playername'),
      goals: this.model.get('goals'),
      assists: this.model.get('assists'),
      card: this.model.get('card'),
      players: players
    };
  },

  cancel: function(ev) {
    app.otherRegion.show(new FooView());
  }
});

var UserModel = Backbone.Model.extend({
  initialize: function(){
    this.listenTo(this, "remove", this.suicide);
  },

  suicide: function() {
    this.destroy();
  }
});

var UserModels = Backbone.Collection.extend({
  model: UserModel,

  url: function() {
    return window.location.pathname + "/players";
  }
});

var UserItemView = Marionette.ItemView.extend({
  template: "#stat-display-template",

  events: {
    "click #remove" : "remove2",
    "click #edit" : "edit"
  },

  edit: function() {
    var entryView = new AddEntryView({model: this.model});

    app.otherRegion.show(entryView);
  },

  remove2: function() {
    app.collection.remove(this.model);
  },

  templateHelpers: function () {
    return {
      getCardLabel: function() {
        switch(this.card) {
            case 'R':
                return "Red"
            case 'Y':
                return "Yellow"
            default:
              return "No"
        }
      }
    }
  },

  serializeData: function() {
    return {
      name: this.model.get('playername'),
      goals: this.model.get('goals'),
      assists: this.model.get('assists'),
      card: this.model.get('card')
    };
  }
});

var UserListView = Marionette.CollectionView.extend({
  childView: UserItemView
});

app.start();

</script>
{% endblock %}

